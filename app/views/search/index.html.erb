<%# app/views/search/index.html.erb %>

<div class="bg-slate-50 min-h-screen">
  <div class="page-wrap py-10">

    <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-6">
      <div>
        <h1 class="text-2xl font-semibold text-slate-900">Search</h1>
        <p class="mt-2 text-sm text-slate-600">
          Showing results for:
          <span class="font-semibold text-slate-900"><%= params[:q].presence || "everything" %></span>
        </p>
      </div>
      <%= link_to "Back home", root_path, class: "text-sm font-semibold text-blue-700 hover:underline" %>
    </div>

    <div class="mt-6 card card-pad">
      <form action="<%= search_path %>" method="get" class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <input name="q" value="<%= params[:q] %>" placeholder="Search services…" class="input" />
        <input name="near" value="<%= params[:near] %>" placeholder="Near (optional)…" class="input" />

        <button class="btn btn-primary justify-center md:justify-self-end md:w-auto w-full">
          Search
        </button>
      </form>
    </div>

    <% if @services.present? %>
      <div class="mt-8 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        <% @services.each do |service| %>
          <% business = (service.respond_to?(:business) ? service.business : nil) %>

          <% business_url =
               if business.present? && business.respond_to?(:slug) && business.slug.present?
                 business_path(business.slug)
               else
                 "#"
               end
          %>

          <% price_label =
               if service.respond_to?(:price_cents) && service.price_cents.present?
                 pounds = service.price_cents.to_i / 100.0
                 "£#{format('%.2f', pounds)}"
               else
                 "—"
               end
          %>

          <div class="card overflow-hidden hover:shadow-md transition">
            <div class="h-44 bg-slate-100">
              <% if service.respond_to?(:image) && service.image.attached? %>
                <%= image_tag service.image, class: "w-full h-full object-cover" %>
              <% else %>
                <div class="w-full h-full"
                     style="background:
                       radial-gradient(900px 500px at 20% 20%, rgba(47,102,255,0.22), transparent 60%),
                       linear-gradient(180deg,#0b1f46 0%, #07142c 100%);">
                </div>
              <% end %>
            </div>

            <div class="p-5">
              <div class="flex items-start justify-between gap-4">
                <div class="min-w-0">
                  <p class="text-sm font-semibold text-slate-900 break-words"><%= service.name %></p>
                  <p class="mt-1 text-xs text-slate-500 truncate"><%= business&.name || "Business" %></p>
                </div>

                <div class="text-right shrink-0">
                  <p class="text-sm font-semibold text-slate-900"><%= price_label %></p>
                  <% if service.respond_to?(:duration_min) && service.duration_min.present? %>
                    <p class="text-xs text-slate-500"><%= service.duration_min %> min</p>
                  <% end %>
                </div>
              </div>

              <% if service.respond_to?(:description) && service.description.present? %>
                <p class="mt-3 text-sm text-slate-600 line-clamp-2"><%= service.description %></p>
              <% end %>

              <div class="mt-5 flex flex-wrap gap-3">
                <%= link_to "View business", business_url, class: "btn btn-outline" %>

                <% if user_signed_in? %>
                  <%= link_to "Book now",
                      new_customer_booking_path(service_id: service.id),
                      class: "btn btn-primary" %>
                <% else %>
                  <%= link_to "Book now",
                      customers_sign_in_path,
                      class: "btn btn-primary" %>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <div class="mt-10 card card-pad text-center">
        <p class="font-semibold text-slate-900">No results yet</p>
        <p class="mt-2 text-sm text-slate-600">
          Try a different keyword (e.g. “lashes”, “barber”, “photographer”).
        </p>
      </div>
    <% end %>

  </div>
</div>
